<entry>
<time>18:11</time>
<subj>Репликация MySQL на одном компьютере</subj>
<text><b>Предупреждение.</b> Если Вы не знакомы с&nbsp;репликацией в&nbsp;mysql, то вряд&nbsp;ли поймёте <nobr>что-нибудь</nobr> из ниженаписанного, Вам следует сперва ознакомиться с&nbsp;<a href="http://www.mysql.com/doc/ru/Replication.html" title="русская документация, в новом окне" target="_blank">документацией по репликации</a> и&nbsp;<a href="http://www.mysql.com/doc/ru/Multiple_servers.html" title="русская документация, в новом окне" target="_blank">по запуску нескольких серверов mysql на одном компьютере</a>.<br><b>Прелюдия.</b> Понадобилось мне организовать двухстороннюю репликацию БД на двух <nobr>mysql-серверах,</nobr> запущенных на одной машине (для обхода блокировки <nobr>myisam-таблиц).</nobr> Казалось&nbsp;бы ничего сложного и&nbsp;особенного тут нет, учитывая то, что я&nbsp;знаю как запускать несколько <nobr>mysql-серверов</nobr> на одной машине и&nbsp;как организовать репликацию БД между двумя разными машинами. Но задача оказалась не самой простой. Не буду рассказывать, как в&nbsp;течение целого дня бился с&nbsp;конфигами, сколько вариантов запуска перепробовал и&nbsp;т.д., а&nbsp;просто напишу про подводные камни:<br><b>Подводный камень №1.</b> У&nbsp;mysql есть параметры <code>master-host,&nbsp;master-port</code>, но нет параметра <code>master-socket</code>, поэтому когда я&nbsp;для первого сервера написал<br><code>master-host&nbsp;=&nbsp;localhost<br>master-port&nbsp;=&nbsp;3307</code>,<br>он цеплялся не к&nbsp;<code>127.0.0.1:3307</code>, а&nbsp;к <code>/tmp/mysql.sock</code>, т.е. к&nbsp;самому себе, а&nbsp;не ко второму серверу. Причём в&nbsp;логах информация о&nbsp;том, куда он на самом деле цепляется случайно появилась только когда я&nbsp;там сильно нахимичил.<br>Обход этой проблемы&nbsp;&#151; написать <code>master-host&nbsp;=&nbsp;127.0.0.1</code>.<br><b>Подводный камень №2.</b> Даже просле того, как я&nbsp;в <code>my.cnf</code> изменил <code>master-host</code> на <code>127.0.0.1</code>, система ни хрена не заработала. Тут причина в&nbsp;том, что оказывается параметр <code>master-host</code> и&nbsp;некоторые другие параметры репликации считываются из основного конфига только в&nbsp;том случае, если <nobr>что-то</nobr> не в&nbsp;порядке с&nbsp;файлом <code>master.info</code> (он создаётся автоматом в&nbsp;каталоге данных), например, он просто отсутствует, а&nbsp;если он существует, то <code>master-host</code> считывается оттуда, и&nbsp;серверу положить, что я&nbsp;там поменял в&nbsp;<code>my.cnf</code>. В&nbsp;документации об этом сказано, но я&nbsp;это нашёл уже после того, как сам выяснил путём эксперимента&hellip; надо было выделить это красным жирным шрифтом, блин.<br>Обход этой проблемы&nbsp;&#151; отредактировать вручную, либо, что проще, удалить <code>master.info</code>, <b>не забыв</b> перед этим <b>остановить сервер</b> mysql. При удалении потеряется оперативная инфа по репликации&nbsp;&#151; текущий файл журнала&nbsp;&#151; так что надо быть осторожным, безопаснее всё же отредактировать.<br><b>Что в&nbsp;итоге получилось.</b> Вот кусок <code>my.cnf</code>, относящийся к&nbsp;делу, с&nbsp;которым всё работает замечательно (версия mysql 4.0.18):<br><code><i><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><br>#&nbsp;MySQL&nbsp;server&nbsp;1</i><br>[mysqld1]<br>port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3306<br>socket&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/tmp/mysql.sock<br>datadir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/data/mysql1<br>pid-file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/data/mysql1/mysqld.pid<br>user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;mysql<p><i>#&nbsp;replication</i><br>log-bin<br>server-id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;1<br>binlog-do-db&nbsp;&nbsp;&nbsp;=&nbsp;test<p>master-host&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;127.0.0.1<br>master-port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3307<br>master-user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;replicator<br>master-connect-retry&nbsp;=&nbsp;10<br>replicate-do-db&nbsp;&nbsp;&nbsp;=&nbsp;test<br><i><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><p><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><br>#&nbsp;MySQL&nbsp;server&nbsp;2</i><br>[mysqld2]<br>port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3307<br>socket&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/tmp/mysql2.sock<br>datadir&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/data/mysql2<br>pid-file&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;/data/mysql2/mysqld.pid<br>user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;mysql<p><i>#&nbsp;replication</i><br>log-bin<br>server-id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;2<br>binlog-do-db&nbsp;&nbsp;&nbsp;=&nbsp;test<p>master-host&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;localhost<br>master-port&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;3306<br>master-user&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;replicator<br>master-connect-retry&nbsp;=&nbsp;10<br>replicate-do-db&nbsp;&nbsp;&nbsp;=&nbsp;test<br><i><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt><tt>##</tt></i></code><p>На первом сервере следует сделать:<br> <code>GRANT&nbsp;REPLICATION&nbsp;SLAVE&nbsp;ON&nbsp;*.*&nbsp;TO&nbsp;replicator@localhost;</code><br>на втором:<br> <code>GRANT&nbsp;REPLICATION&nbsp;SLAVE&nbsp;ON&nbsp;*.*&nbsp;TO&nbsp;replicator@127.0.0.1;</code><p align=justify><b>О производительности (вместо заключения).</b> Как видите, для второго сервера я&nbsp;оставил <code>master-host&nbsp;=&nbsp;localhost</code>, это вполне правомерно, т.к. он будет соединяться с&nbsp;<code>/tmp/mysql.sock</code>, т.е. к&nbsp;первому серверу, а&nbsp;нам туда и&nbsp;надо. Вроде&nbsp;бы как обмен через unix domain около двух раз быстрее, чем через сетевые сокеты. Вряд&nbsp;ли это может сильно повлиять на производительность репликации, тем более, что в&nbsp;большинстве случаев она реализуется между двумя разными машинами через сеть. Но несмотря на это смущает то, что разработчики mysql не предположили случая репликации на одном компьютере и&nbsp;не реализовали параметр <code>master-socket</code>. Написал им <nobr><a href="http://bugs.mysql.com/bug.php?id=3310" target="_blank" title="в новом окне">feature-request</a></nobr> по этому поводу, посмотрим что скажут&hellip;</text>
<keywords>mysql, unix, db</keywords>
<stamp>1080213110</stamp>

<posts>1</posts>
